syntax = "proto3";

option go_package = "github.com/beam-cloud/airstore/proto";

package gateway;

service GatewayService {
  // Workspaces
  rpc CreateWorkspace(CreateWorkspaceRequest) returns (WorkspaceResponse);
  rpc ListWorkspaces(ListWorkspacesRequest) returns (ListWorkspacesResponse);
  rpc GetWorkspace(GetWorkspaceRequest) returns (WorkspaceResponse);
  rpc DeleteWorkspace(DeleteWorkspaceRequest) returns (DeleteResponse);

  // Members
  rpc AddMember(AddMemberRequest) returns (MemberResponse);
  rpc ListMembers(ListMembersRequest) returns (ListMembersResponse);
  rpc RemoveMember(RemoveMemberRequest) returns (DeleteResponse);

  // Tokens (workspace-scoped)
  rpc CreateToken(CreateTokenRequest) returns (CreateTokenResponse);
  rpc ListTokens(ListTokensRequest) returns (ListTokensResponse);
  rpc RevokeToken(RevokeTokenRequest) returns (DeleteResponse);

  // Worker Tokens (cluster-level)
  rpc CreateWorkerToken(CreateWorkerTokenRequest) returns (CreateTokenResponse);
  rpc ListWorkerTokens(ListWorkerTokensRequest) returns (ListTokensResponse);

  // Connections
  rpc AddConnection(AddConnectionRequest) returns (ConnectionResponse);
  rpc ListConnections(ListConnectionsRequest) returns (ListConnectionsResponse);
  rpc RemoveConnection(RemoveConnectionRequest) returns (DeleteResponse);

  // Tasks
  rpc ListTasks(ListTasksRequest) returns (ListTasksResponse);
  rpc GetTask(GetTaskRequest) returns (TaskResponse);
  rpc GetTaskLogs(GetTaskLogsRequest) returns (GetTaskLogsResponse);

  // Hooks
  rpc CreateHook(CreateHookRequest) returns (HookResponse);
  rpc ListHooks(ListHooksRequest) returns (ListHooksResponse);
  rpc GetHook(GetHookRequest) returns (HookResponse);
  rpc UpdateHook(UpdateHookRequest) returns (HookResponse);
  rpc DeleteHook(DeleteHookRequest) returns (DeleteResponse);
  rpc ListHookRuns(ListHookRunsRequest) returns (ListHookRunsResponse);
}

// Common
message DeleteResponse {
  bool ok = 1;
  string error = 2;
}

// Workspace messages
message CreateWorkspaceRequest {
  string name = 1;
}

message ListWorkspacesRequest {}

message GetWorkspaceRequest {
  string id = 1;
}

message DeleteWorkspaceRequest {
  string id = 1;
}

message Workspace {
  string id = 1;
  string name = 2;
  string created_at = 3;
  string updated_at = 4;
}

message WorkspaceResponse {
  bool ok = 1;
  string error = 2;
  Workspace workspace = 3;
}

message ListWorkspacesResponse {
  bool ok = 1;
  string error = 2;
  repeated Workspace workspaces = 3;
}

// Member messages
message AddMemberRequest {
  string workspace_id = 1;
  string email = 2;
  string name = 3;
  string role = 4; // admin, member, viewer
}

message ListMembersRequest {
  string workspace_id = 1;
}

message RemoveMemberRequest {
  string id = 1;
}

message Member {
  string id = 1;
  string workspace_id = 2;
  string email = 3;
  string name = 4;
  string role = 5;
  string created_at = 6;
}

message MemberResponse {
  bool ok = 1;
  string error = 2;
  Member member = 3;
}

message ListMembersResponse {
  bool ok = 1;
  string error = 2;
  repeated Member members = 3;
}

// Token messages
message CreateTokenRequest {
  string workspace_id = 1;
  string member_id = 2;
  string name = 3;
  int64 expires_in_seconds = 4; // 0 = no expiry
}

message ListTokensRequest {
  string workspace_id = 1;
}

message RevokeTokenRequest {
  string id = 1;
}

message Token {
  string id = 1;
  string name = 2;
  string token_type = 3;        // "workspace_member" or "worker"
  string member_id = 4;         // Set for workspace_member tokens
  string pool_name = 5;         // Set for worker tokens (optional)
  string expires_at = 6;
  string created_at = 7;
  string last_used_at = 8;
}

// Worker token messages
message CreateWorkerTokenRequest {
  string name = 1;
  string pool_name = 2;          // Optional, empty = all pools
  int64 expires_in_seconds = 3;  // 0 = no expiry
}

message ListWorkerTokensRequest {
  // No parameters - lists all worker tokens
}

message CreateTokenResponse {
  bool ok = 1;
  string error = 2;
  string token = 3; // Raw token, only returned on create
  Token info = 4;
}

message ListTokensResponse {
  bool ok = 1;
  string error = 2;
  repeated Token tokens = 3;
}

// Connection messages
message AddConnectionRequest {
  string workspace_id = 1;
  string member_id = 2; // Empty = workspace-shared
  string integration_type = 3; // github, weather, exa, etc.
  string access_token = 4;
  string api_key = 5;
  string scope = 6;
}

message ListConnectionsRequest {
  string workspace_id = 1;
}

message RemoveConnectionRequest {
  string id = 1;
}

message Connection {
  string id = 1;
  string workspace_id = 2;
  string member_id = 3;
  string integration_type = 4;
  string scope = 5;
  bool is_shared = 6;
  string created_at = 7;
}

message ConnectionResponse {
  bool ok = 1;
  string error = 2;
  Connection connection = 3;
}

message ListConnectionsResponse {
  bool ok = 1;
  string error = 2;
  repeated Connection connections = 3;
}

// Task messages
message Task {
  string id = 1;
  string status = 2;
  string prompt = 3;
  string image = 4;
  int32 exit_code = 5;
  bool has_exit_code = 6;
  string error = 7;
  string created_at = 8;
  string started_at = 9;
  string finished_at = 10;
}

message ListTasksRequest {}

message ListTasksResponse {
  bool ok = 1;
  string error = 2;
  repeated Task tasks = 3;
}

message GetTaskRequest {
  string id = 1;
}

message TaskResponse {
  bool ok = 1;
  string error = 2;
  Task task = 3;
}

message GetTaskLogsRequest {
  string id = 1;
}

message TaskLogEntry {
  string task_id = 1;
  int64 timestamp = 2;
  string stream = 3;
  string data = 4;
}

message GetTaskLogsResponse {
  bool ok = 1;
  string error = 2;
  repeated TaskLogEntry logs = 3;
}

// Hook messages
message Hook {
  string id = 1;
  string workspace_id = 2;
  string path = 3;
  string prompt = 4;
  bool active = 5;
  string created_at = 6;
  string updated_at = 7;
}

message CreateHookRequest {
  string workspace_id = 1;
  string path = 2;
  string prompt = 3;
}

message ListHooksRequest {
  string workspace_id = 1;
}

message GetHookRequest {
  string id = 1;
}

message UpdateHookRequest {
  string id = 1;
  string prompt = 2;
  bool active = 3;
  bool has_active = 4;
}

message DeleteHookRequest {
  string id = 1;
}

message HookResponse {
  bool ok = 1;
  string error = 2;
  Hook hook = 3;
}

message ListHooksResponse {
  bool ok = 1;
  string error = 2;
  repeated Hook hooks = 3;
}

message ListHookRunsRequest {
  string hook_id = 1;  // hook external ID
}

message HookRun {
  string task_id = 1;
  string status = 2;
  int32 attempt = 3;
  int32 max_attempts = 4;
  string error = 5;
  string created_at = 6;
  string finished_at = 7;
}

message ListHookRunsResponse {
  bool ok = 1;
  string error = 2;
  repeated HookRun runs = 3;
}

