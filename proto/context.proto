syntax = "proto3";

option go_package = "github.com/beam-cloud/airstore/proto";

package context;

// ContextService provides S3-backed file storage (per-workspace buckets).
// Name retained for wire compatibility; implementation is StorageService.
service ContextService {
  // Stat returns file/directory attributes
  rpc Stat(ContextStatRequest) returns (ContextStatResponse);
  
  // ReadDir lists directory contents
  rpc ReadDir(ContextReadDirRequest) returns (ContextReadDirResponse);
  
  // Read reads file content
  rpc Read(ContextReadRequest) returns (ContextReadResponse);
  
  // Write writes file content (creates if not exists)
  rpc Write(ContextWriteRequest) returns (ContextWriteResponse);
  
  // Create creates a new empty file
  rpc Create(ContextCreateRequest) returns (ContextCreateResponse);
  
  // Delete removes a file or empty directory
  rpc Delete(ContextDeleteRequest) returns (ContextDeleteResponse);
  
  // Mkdir creates a directory
  rpc Mkdir(ContextMkdirRequest) returns (ContextMkdirResponse);
  
  // Rename moves/renames a file or directory
  rpc Rename(ContextRenameRequest) returns (ContextRenameResponse);
  
  // Truncate changes file size
  rpc Truncate(ContextTruncateRequest) returns (ContextTruncateResponse);
  
  // Symlink creates a symbolic link
  rpc Symlink(ContextSymlinkRequest) returns (ContextSymlinkResponse);
  
  // Readlink reads a symbolic link target
  rpc Readlink(ContextReadlinkRequest) returns (ContextReadlinkResponse);
  
  // ListTree returns a flat listing of all objects under a prefix (for prefetching)
  rpc ListTree(ListTreeRequest) returns (ListTreeResponse);
}

message FileInfo {
  int64 size = 1;
  uint32 mode = 2;
  int64 mtime = 3;
  bool is_dir = 4;
  bool is_link = 5;
}

message ContextDirEntry {
  string name = 1;
  uint32 mode = 2;
  bool is_dir = 3;
  int64 size = 4;
  int64 mtime = 5;
  string etag = 6;
}

message ContextStatRequest {
  string path = 1;
}

message ContextStatResponse {
  bool ok = 1;
  string error = 2;
  FileInfo info = 3;
}

message ContextReadDirRequest {
  string path = 1;
}

message ContextReadDirResponse {
  bool ok = 1;
  string error = 2;
  repeated ContextDirEntry entries = 3;
}

message ContextReadRequest {
  string path = 1;
  int64 offset = 2;
  int64 length = 3;
}

message ContextReadResponse {
  bool ok = 1;
  string error = 2;
  bytes data = 3;
}

message ContextWriteRequest {
  string path = 1;
  bytes data = 2;
  int64 offset = 3;
}

message ContextWriteResponse {
  bool ok = 1;
  string error = 2;
  int32 written = 3;
}

message ContextCreateRequest {
  string path = 1;
  uint32 mode = 2;
}

message ContextCreateResponse {
  bool ok = 1;
  string error = 2;
}

message ContextDeleteRequest {
  string path = 1;
}

message ContextDeleteResponse {
  bool ok = 1;
  string error = 2;
}

message ContextMkdirRequest {
  string path = 1;
  uint32 mode = 2;
}

message ContextMkdirResponse {
  bool ok = 1;
  string error = 2;
}

message ContextRenameRequest {
  string old_path = 1;
  string new_path = 2;
}

message ContextRenameResponse {
  bool ok = 1;
  string error = 2;
}
message ContextTruncateRequest {
  string path = 1;
  int64 size = 2;
}

message ContextTruncateResponse {
  bool ok = 1;
  string error = 2;
}

message ContextSymlinkRequest {
  string target = 1;
  string link_path = 2;
}

message ContextSymlinkResponse {
  bool ok = 1;
  string error = 2;
}

message ContextReadlinkRequest {
  string path = 1;
}

message ContextReadlinkResponse {
  bool ok = 1;
  string error = 2;
  string target = 3;
}

message ListTreeRequest {
  string path = 1;
  int32 depth = 2;
  int32 max_keys = 3;
  string continuation_token = 4;
}

message ListTreeResponse {
  bool ok = 1;
  string error = 2;
  repeated TreeEntry entries = 3;
  string next_token = 4;
  bool truncated = 5;
}

message TreeEntry {
  string path = 1;
  int64 size = 2;
  int64 mtime = 3;
  uint32 mode = 4;
  string etag = 5;
}
