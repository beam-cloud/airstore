name: Build and release CLI

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      app_version:
        description: Semantic version of release
        required: true
        type: string

permissions:
  actions: write
  contents: write

jobs:
  build:
    if: (github.event_name == 'release' && startsWith(github.ref_name, 'cli-')) || inputs.app_version != ''
    name: build (${{ matrix.platform.target_alt }})
    timeout-minutes: 15

    strategy:
      matrix:
        platform:
          # macos-latest is ARM64, macos-13 is Intel
          - os: macos-latest
            goos: darwin
            goarch: arm64
            target_alt: darwin-arm64
            cc: ""
          - os: macos-13
            goos: darwin
            goarch: amd64
            target_alt: darwin-amd64
            cc: ""
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
            target_alt: linux-amd64
            cc: gcc
          - os: ubuntu-latest
            goos: linux
            goarch: arm64
            target_alt: linux-arm64
            cc: aarch64-linux-gnu-gcc

    runs-on: ${{ matrix.platform.os }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set build info
        id: set-build-info
        run: |
          if [[ ! -z "${{ inputs.app_version }}" ]]; then
            echo "app_version=${{ inputs.app_version }}" >> $GITHUB_OUTPUT
          else
            echo "app_version=${GITHUB_REF_NAME#cli-}" >> $GITHUB_OUTPUT
          fi

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Install FUSE libraries (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse-dev libfuse3-dev
          # Install ARM64 cross-compiler and libraries for linux-arm64 build
          if [ "${{ matrix.platform.goarch }}" = "arm64" ]; then
            sudo apt-get install -y gcc-aarch64-linux-gnu libc6-dev-arm64-cross
          fi

      - name: Install FUSE libraries (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install macfuse

      - name: Build binary
        env:
          GOOS: ${{ matrix.platform.goos }}
          GOARCH: ${{ matrix.platform.goarch }}
          CGO_ENABLED: 1
          CC: ${{ matrix.platform.cc }}
        run: |
          go build -ldflags="-s -w \
            -X github.com/beam-cloud/airstore/pkg/cli.Version=${{ steps.set-build-info.outputs.app_version }} \
            -X github.com/beam-cloud/airstore/pkg/cli.Release=true" \
            -o airstore ./cmd/cli

      - name: Prepare artifact
        id: prepare-artifact
        env:
          GZIP: "-9"
        run: |
          tar -cvzf airstore-${{ steps.set-build-info.outputs.app_version }}-${{ matrix.platform.target_alt }}.tar.gz airstore
          echo "tar_file_path=$(pwd)/airstore-${{ steps.set-build-info.outputs.app_version }}-${{ matrix.platform.target_alt }}.tar.gz" >> $GITHUB_OUTPUT

      - name: Upload artifact to actions run
        uses: actions/upload-artifact@v4
        with:
          name: airstore-${{ steps.set-build-info.outputs.app_version }}-${{ matrix.platform.target_alt }}
          path: airstore
          if-no-files-found: ignore
          compression-level: "9"

      - name: Upload artifact to release
        if: github.event_name == 'release' && startsWith(github.ref_name, 'cli-')
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release upload ${GITHUB_REF_NAME} "${{ steps.prepare-artifact.outputs.tar_file_path }}"
